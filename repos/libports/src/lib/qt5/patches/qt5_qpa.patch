qt5_qpa.patch

From: Christian Prochaska <christian.prochaska@genode-labs.com>
From: Reinier Millo SÃ¡nchez <rmillo@uclv.cu>

---
 .../platformsupport/fontdatabases/basic/qbasicfontdatabase.cpp |  9 +++++++++
 .../input/evdevkeyboard/qevdevkeyboard_defaultmap_p.h          |  4 ++++
 .../input/evdevkeyboard/qevdevkeyboardhandler.cpp              | 10 +++++++++-
 .../input/evdevkeyboard/qevdevkeyboardhandler_p.h              |  6 ++++--
 4 files changed, 26 insertions(+), 3 deletions(-)

diff --git a/qtbase/src/platformsupport/fontdatabases/basic/qbasicfontdatabase.cpp b/qtbase/src/platformsupport/fontdatabases/basic/qbasicfontdatabase.cpp
index 65cdabd..1eb20e1 100644
--- a/qtbase/src/platformsupport/fontdatabases/basic/qbasicfontdatabase.cpp
+++ b/qtbase/src/platformsupport/fontdatabases/basic/qbasicfontdatabase.cpp
@@ -71,7 +71,16 @@ void QBasicFontDatabase::populateFontDatabase()
     for (int i = 0; i < int(dir.count()); ++i) {
         const QByteArray file = QFile::encodeName(dir.absoluteFilePath(dir[i]));
 //        qDebug() << "looking at" << file;
+#ifdef Q_OS_GENODE
+        QByteArray data;
+        QFile f(file);
+        if (!f.open(QIODevice::ReadOnly))
+            continue;
+        data = f.readAll();
+        addTTFile(data, file);
+#else
         addTTFile(QByteArray(), file);
+#endif
     }
 }
 
diff --git a/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboard_defaultmap_p.h b/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboard_defaultmap_p.h
index 34f20f4..6e8bcbd 100644
--- a/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboard_defaultmap_p.h
+++ b/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboard_defaultmap_p.h
@@ -46,7 +46,9 @@
 //
 
 #include "qnamespace.h"
+#ifndef Q_OS_GENODE
 #include "linux/input.h"
+#endif /* Q_OS_GENODE */
 
 // no QT_BEGIN_NAMESPACE, since we include it internally...
 
@@ -638,6 +640,7 @@ const QEvdevKeyboardMap::Mapping QEvdevKeyboardHandler::s_keymap_default[] = {
     { 111, 0xffff, 0x01000000, 0x06, 0x08, 0x0200 },
     { 111, 0xffff, 0x01000000, 0x0c, 0x08, 0x0200 },
 
+#ifndef Q_OS_GENODE
     // 113 -> 248
     { KEY_MUTE,         0xffff, Qt::Key_VolumeMute,     0x00, 0x00, 0x0000 },
     { KEY_VOLUMEDOWN,   0xffff, Qt::Key_VolumeDown,     0x00, 0x00, 0x0000 },
@@ -666,6 +669,7 @@ const QEvdevKeyboardMap::Mapping QEvdevKeyboardHandler::s_keymap_default[] = {
     { KEY_BLUE,         0xffff, Qt::Key_Blue,           0x00, 0x00, 0x0000 },
     { KEY_CHANNELUP,    0xffff, Qt::Key_ChannelUp,      0x00, 0x00, 0x0000 },
     { KEY_CHANNELDOWN,  0xffff, Qt::Key_ChannelDown,    0x00, 0x00, 0x0000 },
+#endif /* Q_OS_GENODE */
 };
 
 const QEvdevKeyboardMap::Composing QEvdevKeyboardHandler::s_keycompose_default[] = {
diff --git a/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboardhandler.cpp b/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboardhandler.cpp
index 16cb94d..61342c6 100644
--- a/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboardhandler.cpp
+++ b/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboardhandler.cpp
@@ -42,7 +42,9 @@
 #include <qpa/qwindowsysteminterface.h>
 #include <private/qcore_unix_p.h>
 
-#include <linux/input.h>
+#ifndef Q_OS_GENODE
+ #include <linux/input.h>
+#endif /* Q_OS_GENODE */
 
 QT_BEGIN_NAMESPACE
 
@@ -67,10 +69,12 @@ QEvdevKeyboardHandler::QEvdevKeyboardHandler(const QString &device, int fd, bool
     if (keymapFile.isEmpty() || !loadKeymap(keymapFile))
         unloadKeymap();
 
+#ifndef Q_OS_GENODE
     // socket notifier for events on the keyboard device
     QSocketNotifier *notifier;
     notifier = new QSocketNotifier(m_fd, QSocketNotifier::Read, this);
     connect(notifier, SIGNAL(activated(int)), this, SLOT(readKeycode()));
+#endif /* Q_OS_GENODE */
 }
 
 QEvdevKeyboardHandler::~QEvdevKeyboardHandler()
@@ -81,6 +85,7 @@ QEvdevKeyboardHandler::~QEvdevKeyboardHandler()
         qt_safe_close(m_fd);
 }
 
+#ifndef Q_OS_GENODE
 QEvdevKeyboardHandler *QEvdevKeyboardHandler::create(const QString &device,
                                                      const QString &specification,
                                                      const QString &defaultKeymapFile)
@@ -198,6 +203,7 @@ void QEvdevKeyboardHandler::readKeycode()
         }
     }
 }
+#endif /* Q_OS_GENODE */
 
 void QEvdevKeyboardHandler::processKeyEvent(int nativecode, int unicode, int qtcode,
                                             Qt::KeyboardModifiers modifiers, bool isPress, bool autoRepeat)
@@ -455,6 +461,7 @@ void QEvdevKeyboardHandler::unloadKeymap()
     m_composing = 0;
     m_dead_unicode = 0xffff;
 
+#ifndef Q_OS_GENODE
     //Set locks according to keyboard leds
     quint16 ledbits[1];
     memset(ledbits, 0, sizeof(ledbits));
@@ -475,6 +482,7 @@ void QEvdevKeyboardHandler::unloadKeymap()
             m_locks[2] = 1;
         qCDebug(qLcEvdevKey, "numlock=%d , capslock=%d, scrolllock=%d", m_locks[1], m_locks[0], m_locks[2]);
     }
+#endif /* Q_OS_GENODE */
 }
 
 bool QEvdevKeyboardHandler::loadKeymap(const QString &file)
diff --git a/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboardhandler_p.h b/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboardhandler_p.h
index 90142c6..8165c95 100644
--- a/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboardhandler_p.h
+++ b/qtbase/src/platformsupport/input/evdevkeyboard/qevdevkeyboardhandler_p.h
@@ -169,8 +169,10 @@ public:
     bool loadKeymap(const QString &file);
     void unloadKeymap();
 
-private slots:
-    void readKeycode();
+#ifndef Q_OS_GENODE
+ private slots:
+     void readKeycode();
+#endif /* Q_OS_GENODE */
     KeycodeAction processKeycode(quint16 keycode, bool pressed, bool autorepeat);
 
 private:
